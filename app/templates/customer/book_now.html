{% extends 'customer/base.html' %}

{% block title %}Book Online From Sagar-services{% endblock %}

{% block content %}


<div class="container-fluid px-0">
    <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('home.index') }}"><i class="bi bi-house"></i></a></li>
            <li class="breadcrumb-item active" aria-current="page">Book</li>
        </ol>
    </nav>

    <div class="container-fluid row row d-flex justify-content-start mt-5">
        <div class="col-lg-5 col-md-5 d-none d-md-block">
          <img src="../../static/img/gif.gif" alt="" class="checkout-img" style="opacity: 0.3; object-fit: contain;">
        </div>
        <div class="col-lg-6 col-md-6 col-sm-12" >
        <form class="shadow-sm rounded-0 adminForm" id="accordionPanelsStayOpenExample" method="POST" action="{{url_for('booking.confirm')}}">
            <div class="rounded-0">
              <h2 class="rounded-0 text-center">
                  <i class="bi bi-check-circle check1" style="display: none;"></i> &nbsp; Booking Summary
              </h2>
              <div id="panelsStayOpen-collapseOne">
                <div class="p-1 rounded-0">
                  <table class="table table-responsive table-bordered table-hover">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Service</th>
                            <th>Charge</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                      <tbody>
                          <tr id="service_row_{{service.id}}">
                              <input type="hidden" name="service_id" value="{{service.id}}" id="service_id">
                              <td><img src="{{ url_for('static', filename=service.service_img_urls[0]) }}" class="product-img" alt="Service Image" height="67px" width="67px"></td>
                              <td class="text-primary">{{ service.service_name }}</td>
                              <td>₹ <span>{{ service.service_charge }}</span>/-</td>
                              <td>₹ <span class="sub_total_price">{{ service.service_charge-service.discount }}</span>/-</td>
                          </tr>
                      </tbody>
                      <tfoot class="">
                          <tr>
                              <td colspan="3"><strong>Total Amount</strong></td>
                              <td>₹ <span id="total_price">{{ service.service_charge - service.discount }}</span>/-</td>
                          </tr>
                      </tfoot>
                  </table>
                </div>
                </div>
            </div>
            <div class="">
              <div>
                <div>
                  <div class="user border shadow-sm p-3">
                    <strong class="pe-1">Name:</strong> {{user.first_name + " "+user.last_name}}
                    <br><strong class="pe-1">Email:</strong> {{user.email}}
                    <br><strong class="pe-1">Address:</strong> {{user.address}}
                    <br><strong class="pe-1">Pincode:</strong> <span id="prev_pincode">{{user.pincode}}</span>
                    <br><strong class="pe-1">Contact No:</strong> {{user.mobile}}
                    </br>
                    <div class="mt-2">
                        {% if user.pincode==None %}
                        <strong class="d-none">
                            <input type="checkbox" name="new-address" id="addressCheckbox" checked>
                            <label for="addressCheckbox">Ship To New Address</label>
                        </strong>
                          {% else %}
                        <strong class="">
                            <input type="checkbox" name="new-address" id="addressCheckbox">
                            <label for="addressCheckbox">Ship To New Address</label>
                        </strong>
                          {% endif %}
                    </div>
                  </div>
                    <div id="newAddressForm" class="mt-3 border shadow-sm p-3 bg-body-tertiary">
                      <h5 class="pb-3 text-center"><strong>Enter New Address</strong></h5>
                      <div class="row">
                          <div class="col-6 mb-3">
                              <label for="MobleNo" class="form-label">Mobile No.</label>
                              <input type="number" class="form-control" id="MobleNo" name="MobileNo" placeholder="Enter Mobile No">
                          </div>
                          <div class="col-6 mb-3">
                              <label for="newCity" class="form-label">Street Address</label>
                              <input type="text" class="form-control" id="StreetAddress" name="StreetAddress" placeholder="Flat/House No./Floor/Building/Street">
                          </div>
                          <div class="col-6 mb-3">
                              <label for="Landmark" class="form-label">Landmark</label>
                              <input type="text" class="form-control" id="Landmark" name="Landmark" placeholder="Enter Landmark Here">
                          </div>
                          <div class="col-6 mb-3">
                              <label for="AdditionalAddress" class="form-label">Additional Address</label>
                              <input type="text" class="form-control" id="AdditionalAddress" name="Additional Address" placeholder="colony/Locality">
                          </div>
                          <div class="col-6 mb-3">
                              <label for="City" class="form-label">City</label>
                              <input type="text" class="form-control" id="City" name="City" placeholder="Enter City/Village Name Here">
                          </div>
                          <div class="col-6 mb-3">
                              <label for="State" class="form-label">State</label>
                              <input type="text" class="form-control" id="State" name="State" placeholder="Enter State Here">
                          </div>
                          <div class="col-6 mb-3">
                              <label for="PinCode" class="form-label">Pin Code</label>
                              <input type="text" class="form-control" id="PinCode" name="PinCode" placeholder="Enter 6 Digit Pin Code">
                          </div>
                        </div>
                        
                      </div>
                      </div>
                  </div>
            </div>
            <div class="rounded-0 mb-5 mt-4">
                <div id="panelsStayOpen-collapseThree">
                  <div class="p-2 rounded-0 border shadow-sm">
                    <strong>Please select the preferred payment method to use on this order.</strong> 
                    <br>
                    <div>
                      <input type="radio" value="1" name="pay-method" id="COD" required><label for="COD"> &nbsp; Payment by COD</label>
                    </div>
                    <div>
                      <input type="radio" value="2" name="pay-method" id="Online" disabled><label for="Online"> &nbsp; Payment by UPI/Wallet/Debit & Credit Card</label> (Currently This feature is Not Available)
                    </div>
                    <div>
      
                    </div>
                   <div class="d-flex justify-content-end">
                    <input type="submit" class="btn m-3 third-btn btn-blue" id="place_order" value="BOOK NOW">
                   </div>
                  </div>
                </div>
            </div>
        </form>
    </div>

    </div>
        <div id="pincode_available_messages">
                          
        </div>
        </div>
      </div>
</div>

<script>
    const addressCheckbox = document.getElementById('addressCheckbox');
    const newAddressForm = document.getElementById('newAddressForm');
    $(document).ready(()=> {
        window.update_availability=function(pincode){
            $("#pincode_available_messages").html("")
            $.ajax({
                url: "{{url_for('service.check_area_availability')}}",
                method: 'POST',
                dataType: "json",
                data: {
                    "service_id": service_id,
                    "pincode":pincode
                },
                complete: (res) => {
                    res.then(data => {
                        if(!data.is_available){
                          $("#service_row_"+service_id).addClass('text-decoration-line-through text-danger')
                          $("#pincode_available_messages").append(`<p class="text-danger">NOTE: ${data.message}</p>`)
                          $("#place_order").attr("disabled",true)
                        }
                        else{
                            $("#place_order").attr("disabled",false)
                            $("#service_row_"+service_id).removeClass('text-decoration-line-through text-danger')
                        }
                    });
                }
            });
        }



        var prev_pincode = $("#prev_pincode").text()
        var service_id = $("#service_id").val();
        if(prev_pincode != '' && prev_pincode != null){
            console.log("hi")
            update_availability(prev_pincode);
        }
        
        if ($("#addressCheckbox").prop("checked")) {
          $("accordionPanelsStayOpenExample").addClass("adminForm")
          $("input[type='text']").prop("required",true);
          $("#newAddressForm").removeClass("d-none")
        } 
        else {
            $("#place_order").attr("disabled",true)
            update_availability(prev_pincode);
            $("accordionPanelsStayOpenExample").removeClass("adminForm")
            $("#newAddressForm").addClass("d-none")
            $("input[type='text']").prop("required",false);
            $("#newAddressForm").addClass("d-none");
        }

        $("#addressCheckbox").on("change", function() {
            var prev_pincode = $("#prev_pincode").text()
            if ($("#addressCheckbox").prop("checked")) {
                $("#place_order").attr("disabled",true)
                $("input[type='text']").prop("required",true);
                $("#newAddressForm").removeClass("d-none")
                $("accordionPanelsStayOpenExample").addClass("adminForm")
            } 
            else {
                update_availability(prev_pincode);
                $("input[type='text']").prop("required",false);
                $("#newAddressForm").addClass("d-none")
                $("accordionPanelsStayOpenExample").removeClass("adminForm")
            }
        });

        $("#PinCode").on("focusout",function (){
            $("#pincode_available_messages").html("")
            var new_pincode = $(this).val()
            update_availability(new_pincode);
        })
    });
</script>
{% endblock %}